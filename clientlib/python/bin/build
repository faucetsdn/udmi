#!/bin/bash -e
#
# This script builds the Python client library.
#
# It performs the following steps:
# 1. Sets up path variables.
# 2. Ensures Python 3 and pyproject.toml are present.
# 3. Creates or updates a Python virtual environment (venv).
# 4. Installs Poetry.
# 5. Installs project dependencies via Poetry.
# 6. Builds the final package (wheel and sdist).
#

set -euo pipefail

# --- Variable Definitions ---
echo "Setting up script variables..."
SCRIPT_ROOT=$(realpath "$(dirname "$0")")
LIB_ROOT=$(realpath "$SCRIPT_ROOT/..")
UDMI_ROOT=$(realpath "$SCRIPT_ROOT/../../..")
VENV_DIR="$LIB_ROOT/venv"
PYPROJECT_FILE="$UDMI_ROOT/pyproject.toml"
POETRY_VERSION="2.0.1"

# Source the common shell functions
source "$UDMI_ROOT/etc/shell_common.sh"

# --- Prerequisite Checks ---
echo "Checking prerequisites..."

# 1. Check for python3
if ! command -v python3 &> /dev/null; then
    fail "python3 could not be found. Please install Python 3."
fi
echo "  - python3 found."

# 2. Check for pyproject.toml
if [ ! -f "$PYPROJECT_FILE" ]; then
    fail "pyproject.toml not found at $PYPROJECT_FILE. This script must be run from within a valid Poetry project."
fi
echo "  - pyproject.toml found."

# --- Main Logic ---
# 1. Setup python environment
if [ -d "$VENV_DIR" ]; then
    echo "Virtual environment already exists. Activating."
else
    echo "Creating new virtual environment at $VENV_DIR..."
    python3 -m venv "$VENV_DIR"
fi
source "$VENV_DIR/bin/activate"
echo "Virtual environment activated."

# 2. Install/Upgrade Poetry
echo "Installing Poetry v$POETRY_VERSION..."
pip install "poetry==$POETRY_VERSION"
echo "Poetry installed."

# 3. Install dependencies
echo "Installing project dependencies with Poetry..."
"$VENV_DIR/bin/poetry" install
echo "Dependencies installed."

# 4. Build the package
echo "Building the package..."
"$VENV_DIR/bin/poetry" build
echo "Package built successfully."

# --- Success ---
echo "--------------------------------------------------------------"
echo "Build complete. Artifacts are in $UDMI_ROOT/dist/"
echo "--------------------------------------------------------------"