#!/bin/bash -e

rundir=$(dirname $0)
cd $rundir/..

echo Running in $PWD

OUT_DIR=secrets/

rm -rf $OUT_DIR
mkdir -p $OUT_DIR

INDEX=$OUT_DIR/proxy_index.json

echo "{" > $INDEX

echo '"proxy_sites": [' > $INDEX

SITES_DIR=../sites
sites=`ls $SITES_DIR`
echo Processing sites $sites
for site in $sites; do
    echo \"$site\", >> $INDEX
    IN_DIR=$SITES_DIR/$site
    registry=$(jq -r .registryId $IN_DIR/core_proxy.json)
    cp $IN_DIR/core_proxy.json $OUT_DIR/${registry}_proxy.json
    cp $IN_DIR/cloud_iot_config.json $OUT_DIR/${registry}_cloud.json
    devices=`ls $IN_DIR/devices`
    echo Processing $site devices $devices 
    for device in $devices; do
        cp $IN_DIR/devices/$device/rsa_private.pkcs8 $OUT_DIR/${registry}_${device}_rsa.pkcs8 || true
    done
done

echo "] }" >> $INDEX

echo Try:
echo "  " kubectl delete secret site-config
echo "  " kubectl create secret generic site-config --from-file=$OUT_DIR
