#!/bin/bash -e

UDMI_ROOT=$(dirname $0)/..
source $UDMI_ROOT/etc/shell_common.sh

[[ $# == 1 ]] || usage site_model

site_model=$(realpath $1)
shift

cd $UDMI_ROOT

docker rm udmis || true

[[ -f $site_model/cloud_iot_config.json ]] || fail missing $site_model/cloud_iot_config.json

IMAGE_TAG=ghcr.io/faucetsdn/udmi:latest
docker inspect -f '{{.Id}}' --type=image udmis:latest && IMAGE_TAG=udmis:latest

cmd="docker run -d --name udmis -p 8883:8883 \
       -v $site_model:/root/site \
       -v $PWD/var/etcd:/root/default.etcd \
       -v $PWD/var/mosquitto:/etc/mosquitto \
       $IMAGE_TAG udmi/bin/start_local block site/ //mqtt/localhost"

echo exec: $cmd
$cmd

echo Waiting 30s for container startup...
sleep 30

echo :::::::::::::: docker logs udmis
docker logs udmis

echo :::::::::::::: docker ps
docker ps

echo ::::::::::::::
