#!/bin/bash -e

OLD_PID=$(ps ax | fgrep java | fgrep local_pod.json | awk '{print $1}')
if [[ -n $OLD_PID ]]; then
    echo Killing old udmis process $OLD_PID
    sudo kill $OLD_PID
    sleep 2
fi

rm -f /tmp/pod_ready.txt

bin/container udmis prep --no-check

LOGFILE=out/udmis.log

export ETCD_CLUSTER=localhost
export SSL_SECRETS_DIR=/etc/mosquitto/certs

sudo PATH=$PATH -E udmis/bin/run udmis/etc/local_pod.json > $LOGFILE 2>&1 &

PID=$!

echo udmis started as pid $PID, waiting for stability...
sleep 10

tail $LOGFILE

echo udmis running in the background, pid $PID log in $(realpath $LOGFILE)
