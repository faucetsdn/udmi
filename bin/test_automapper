#!/bin/bash -e

UDMI_ROOT=$(dirname $0)/..
cd $UDMI_ROOT

source etc/shell_common.sh

if [[ $# != 1 ]]; then
   usage PROJECT_SPEC
fi

project_spec=$1
shift

site_path=sites/udmi_site_model

bin/registrar $site_path $project_spec -x -d

# Initialize the system to have no proxied devices present
metadata=$site_path/devices/GAT-123/metadata.json
jq '.gateway.proxy_ids = []' $metadata | sponge $metadata

bin/registrar $site_path $project_spec GAT-123

! fgrep _vendor $site_path/out/registration_summary.csv

pubber_bg GAT-123

bin/mapper GAT-123 provision

bin/mapper GAT-123 discover

bin/registrar $site_path $project_spec

status=$(fgrep _vendor-281 $site_path/out/registration_summary.csv | awk '{print $3}') || fail no vendor device found
echo vendor device status is $status
[[ $status == BLOCK, ]] || fail Vendor device status should be BLOCK

type=$(jq -r .resource_type sites/udmi_site_model/extras/_vendor-20231/cloud_model.json)
echo vendor extracted device type $type
[[ $type == DEVICE ]] || fail Vendor device type should be DEVICE

echo
echo Done with automapper test
