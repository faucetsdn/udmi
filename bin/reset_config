#!/bin/bash -e

ROOT=$(realpath $(dirname $0)/..)

if [[ $# != 3 && $# != 4 ]]; then
    echo Usage: $0 site_dir project_id device_id [config_filename]
    echo "  config_filename defaults to generated_config.json"
    false
fi

site_dir=$(realpath $1)
project_id=$2
device_id=$3
shift 3

filename=generated_config.json
if [[ -n $1 ]]; then
    filename=$1
    shift
fi

cd $ROOT

device_config=/tmp/${device_id}_config.json
cp $site_dir/devices/${device_id}/out/$filename $device_config
now_date=$(date -Ins -u | sed -E 's/.{6}\+.*/Z/' | tr , .)
echo Setting config timestamp $now_date
jq .timestamp=\"$now_date\" < $device_config | sponge $device_config

echo Resetting device $device_id config...
validator/bin/reflector $site_dir $project_id $device_id update/config:$device_config
