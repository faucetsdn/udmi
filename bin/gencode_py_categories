#!/usr/bin/env python3
""" Gencode generator for categories """
import re
import sys
import os

INPUT_FILE = "docs/specs/categories.md"
OUTPUT_FILE = "gencode/python/udmi/schema/category.py"

REGEX = re.compile(
  r"^(\s*)\*\s+_([a-zA-Z0-9]+)_:\s*(?:\(\*\*([A-Z]+)\*\*\))?\s*(.*)")

def generate_header():
  return [
      "\"\"\"",
      "This module defines the Category enum, representing system event "
      "categories",
      "and their default logging levels.",
      "\"\"\"",
      "from enum import Enum",
      "from .level import Level",
      "",
      "class Category(Enum):",
      "    \"\"\"",
      "    This class is manually curated, auto-generated, and then copied "
      "into the directory.",
      "    Look for the proper source and don't be fooled! Ultimately sourced"
      " from docs/specs/categories.md",
      "    \"\"\"",
      ""
  ]

def generate_footer():
  return [
      "",
      "    def __init__(self, value_str: str, default_level: Level):",
      "        self._value_str = value_str",
      "        self.default_level = default_level",
      "",
      "    @property",
      "    def value(self) -> str:",
      "        return self._value_str",
      "",
      "    @property",
      "    def level(self) -> int:",
      "        return self.default_level.value",
      "",
      "    def __str__(self) -> str:",
      "        return self._value_str"
  ]

def process_file():
  if not os.path.exists(INPUT_FILE):
    print(f"Error: Could not find {INPUT_FILE}")
    sys.exit(1)

  with open(INPUT_FILE, "r", encoding="utf-8") as f:
    lines = f.readlines()

  path_stack = []
  entries = []

  for line in lines:
    match = REGEX.match(line)
    if match:
      indent_str = match.group(1)
      name = match.group(2)
      level = match.group(3)
      description = match.group(4).strip()

      current_indent = len(indent_str)

      while path_stack and path_stack[-1][0] >= current_indent:
        path_stack.pop()

      path_stack.append((current_indent, name))

      if level:
        full_path = ".".join([item[1] for item in path_stack])
        const_name = full_path.upper().replace(".", "_")

        entries.append({
            "const": const_name,
            "val": full_path,
            "level": level,
            "desc": description
        })

  return entries

def write_output(entries):
  os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=True)

  with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
    for line in generate_header():
      f.write(line + "\n")

    for entry in entries:
      c_name = entry["const"]
      c_val = entry["val"]
      lvl = entry["level"]
      desc = entry["desc"]

      f.write(f"    # {desc}\n")
      # Enum member definition: NAME = ("value", Level.CONST)
      f.write(f"    {c_name} = (\"{c_val}\", Level.{lvl})\n\n")

    for line in generate_footer():
      f.write(line + "\n")

  print(f"Generated {len(entries)} categories into {OUTPUT_FILE}")

if __name__ == "__main__":
  file_entries = process_file()
  write_output(file_entries)
