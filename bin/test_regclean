#!/bin/bash -ex

# Force consistent sort order
export LC_ALL=C

ROOT_DIR=$(dirname $0)/..
cd $ROOT_DIR

if [[ $# -ne 1 ]]; then
    echo Usage: $0 PROJECT_ID
    false
fi

project_id=$1
shift

[[ -n $GITHUB_RUN_NUMBER ]] && echo "Workflow run number $GITHUB_RUN_NUMBER" || true
echo "Using target project=$project_id"
echo "Using UDMI_REGISTRY_SUFFIX=$UDMI_REGISTRY_SUFFIX"
echo "Using UDMI_ALT_REGISTRY=$UDMI_ALT_REGISTRY"
echo "Using UDMI_REFLECTOR_ENDPOINT=$UDMI_REFLECTOR_ENDPOINT"
echo "Using UDMI_PUBBER_ENDPOINT=$UDMI_PUBBER_ENDPOINT"

site_path=sites/udmi_site_model
output_file=$site_path/out/registration_summary.json
pubber_config=/tmp/pubber_config.json
serial_no=$RANDOM
device_id=AHU-1

echo Clean site out/ directory...
rm -rf $site_path/out

if [[ -n $UDMI_REFLECTOR_ENDPOINT ]]; then
    endpoint=$(base64 --decode <<< $UDMI_REFLECTOR_ENDPOINT)
    echo $endpoint
    site_arg=out/cloud_iot_config-reflect.json
    jq --argjson endpoint "$endpoint" '.reflector_endpoint = $endpoint' \
       $site_path/cloud_iot_config.json > $site_arg
    jq ".project_id = \"$project_id\"" $site_arg | sponge $site_arg
    jq ".site_model = \"$site_path\"" $site_arg | sponge $site_arg
    echo $site_arg:
    cat $site_arg
    registrar_project=
else
    site_arg=$site_path
    registrar_project=$project_id
fi

cat <<EOF > $pubber_config
{
    "sitePath": "$site_path",
    "deviceId": "$device_id",
    "projectId": "$project_id",
    "serialNo": "$serial_no",
    "options": {
      "smokeCheck": true
    }
}
EOF

if [[ -n $UDMI_PUBBER_ENDPOINT ]]; then
    endpoint=$(base64 --decode <<< $UDMI_PUBBER_ENDPOINT)
    echo $endpoint
    jq --argjson endpoint "$endpoint" '.endpoint = $endpoint' \
       $pubber_config | sponge $pubber_config
fi

echo $pubber_config:
cat $pubber_config

echo Clean out the registry to make sure devices get removed...
bin/registrar $site_arg $registrar_project -d

echo Checking reported cloud version info
jq .cloud_version.udmi_functions $output_file

echo Check for failure in running pubber...
RESULT=0
pubber/bin/run $pubber_config || RESULT=$?

echo Now recreate the registry from scratch!
bin/registrar $site_arg $registrar_id -u

echo And check again, but this time with success...
pubber/bin/run $pubber_config

echo Successful pubber check passed on clean registry.
