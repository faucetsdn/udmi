#!/bin/bash -e

UDMI_ROOT=$(dirname $0)/..
source $UDMI_ROOT/etc/shell_common.sh

[[ $# == 2 ]] || fail Usage: $0 site_model project_spec

site_model=$(realpath $1)
project_spec=$2
shift

echo "export TARGET_PROJECT=${project_spec:-}"
echo "export UDMI_REGISTRY_SUFFIX=${UDMI_REGISTRY_SUFFIX:-}"
echo "export UDMI_ALT_REGISTRY=${UDMI_ALT_REGISTRY:-}"

cd $UDMI_ROOT

if [[ ! -d etc/ ]]; then
    echo Migrating support scripts to etc...
    mkdir etc/
    mv var/*.sh etc/
fi

if [[ ! $project_spec =~ ^//mqtt/ ]]; then
    echo Not a local setup, doing nothing!
    exit 0
fi

site_config=$site_model/cloud_iot_config.json
registry_id=$(jq -r .registry_id $site_config)${UDMI_REGISTRY_SUFFIX:-}

bin/start_etcd

bin/setup_ca $site_model
bin/start_mosquitto

source $UDMI_ROOT/etc/mosquitto_ctrl.sh

$MOSQUITTO_CTRL deleteClient $SERV_USER
$MOSQUITTO_CTRL createClient $SERV_USER -p $SERV_PASS # No client_id to allow multiple backend connections.
$MOSQUITTO_CTRL addClientRole $SERV_USER service

bin/mosquctl_site $site_model

if [[ -n ${UDMI_ALT_REGISTRY:-} ]]; then
    bin/mosquctl_site $site_model $UDMI_ALT_REGISTRY
fi

# Global access to logs for connection tracking by UDMIS.
sudo chmod a+r /var/log/mosquitto/mosquitto.log

bin/start_udmis

echo Done with local server setup.
