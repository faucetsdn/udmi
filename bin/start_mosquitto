#!/bin/bash -e

ETC_DIR=/etc/mosquitto
CONF_FILE=$ETC_DIR/mosquitto.conf
UDMI_FILE=$ETC_DIR/confg.d/udmi.conf
PASS_FILE=$ETC_DIR/mosquitto.passwd
DYN_FILE=$ETC_DIR/dynamic_security.json

[[ -n $MQTT_USER ]] || MQTT_USER=scrumptious
[[ -n $MQTT_PASS ]] || MQTT_PASS=aardvark
echo Configuring MQTT user: $MQTT_USER

sudo sed -i 's/allow_anonymous true/allow_anonymous false/' $CONF_FILE
sudo sed -i 's/#listener/listener/' $CONF_FILE
fgrep $PASS_FILE $CONF_FILE || (echo password_file ${PASS_FILE} | sudo tee -a $CONF_FILE)

if ! fgrep -q $DYN_FILE $CONF_FILE; then
    PLUGIN_FILE=$(whereis -b mosquitto_dynamic_security.so | awk '{print $2}')
    ls -l "$PLUGIN_FILE"
    echo Installing dynamic security plugin $PLUGIN_FILE
    echo plugin $PLUGIN_FILE | sudo tee -a $CONF_FILE
    echo plugin_opt_config_file $DYN_FILE | sudo tee -a $CONF_FILE
fi

sudo touch $PASS_FILE $DYN_FILE
sudo chmod 0600 $PASS_FILE $DYN_FILE
sudo chown mosquitto $PASS_FILE $DYN_FILE $CONF_FILE

sudo mosquitto_passwd -b ${PASS_FILE} ${MQTT_USER} ${MQTT_PASS}

sudo systemctl restart mosquitto

systemctl status mosquitto
