#!/bin/bash -e

# Force consistent sort order
export LC_ALL=C

ROOT_DIR=$(realpath $(dirname $0)/..)
cd $ROOT_DIR

if [[ $# != 1 ]]; then
    echo Usage: $0 PROJECT_ID
    false
fi
project_id=$1
shift

site_path=sites/udmi_site_model
device_id=AHU-1

serial_no=validator-$RANDOM
echo Using pubber with serial $serial_no

PUBBER_OUT=pubber.out
VALIDATOR_OUT=validator.out
WAITING=10

vids=`ps ax | fgrep validator | fgrep java | awk '{print $1}'`
pids=`ps ax | fgrep pubber | fgrep java | awk '{print $1}'`
if [[ -n "$pids$vids" ]]; then
    echo Killing pids $pids $vids
    kill $pids $vids
fi

rm -rf $site_path/out/devices

# Prepare auth key used by reflector
mkdir -p $site_path/validator
cp $site_path/devices/AHU-1/rsa_private.pkcs8 $site_path/validator/rsa_private.pkcs8

pubber/bin/build

bin/reset_config $site_path $project_id $device_id

echo Starting validator, output in $VALIDATOR_OUT
bin/validator $site_path $project_id > $VALIDATOR_OUT 2>&1 &
for i in `seq 1 $WAITING`; do
    if fgrep "Entering message loop" $VALIDATOR_OUT; then
        break
    fi
    echo Waiting for validator startup $((WAITING - i))...
    sleep 2
done

if [[ $i -eq $WAITING ]]; then
    echo validator startup failed:
    cat $VALIDATOR_OUT
    false
fi
echo Started validator pid $vpid

echo Writing pubber output to $PUBBER_OUT
cmd="bin/pubber $site_path $project_id $device_id $serial_no extraField=prlagle"
echo $cmd
$cmd > $PUBBER_OUT 2>&1 &

for i in `seq 1 $WAITING`; do
    if fgrep "Connection complete" $PUBBER_OUT; then
        break
    fi
    echo Waiting for pubber startup $((WAITING - i))...
    sleep 2
done

if [[ $i -eq $WAITING ]]; then
    echo pubber startup failed:
    cat $PUBBER_OUT
    false
fi

echo Waiting for system to run for a bit...
timeout 60s tail -f $VALIDATOR_OUT || true

vids=`ps ax | fgrep validator | fgrep java | awk '{print $1}'`
pids=`ps ax | fgrep pubber | fgrep java | awk '{print $1}'`
if [[ -n "$pids$vids" ]]; then
    echo Killing pids $pids $vids
    kill $pids $vids
fi

outfiles=`find $site_path/out/devices -name \*.out | sort` || true
if [[ -z $outfiles ]]; then
    echo No .out files found in $site_path/out/devices
    false
fi

echo Found out files $outfiles, copying to /tmp/validator.out

# Include /dev/null so that more has >1 to chomp on and outputs headers.
more /dev/null $outfiles | sed -E > /tmp/validator.out \
        -e "s/[0-9-]{10}T[0-9:]{8}Z/1999-10-20T01:02:03Z/" \
        -e 's/\\t[a-zA-Z .()$0-9]+\.java:[0-9]+\)\\n/\\tredacted\\n/g' \
