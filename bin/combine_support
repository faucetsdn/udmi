#!/bin/bash -e

archive=$1
shift

sites_in=sites/udmi_site_model_*/
sites_out=sites/udmi_site_model/out
archive_dir=${archive%/}
archive_dir=${archive_dir%.zip}
archive_dir=${archive_dir##*/}

rm -rf out_* $sites_in
rm -f *_udmi-support_*.tgz

rm -rf out $sites_out
mkdir -p out $sites_out

if [[ -f $archive ]]; then
    echo Extracting archive to $archive_dir
    unzip -o $archive -d $archive_dir
elif [[ ! -d $archive ]]; then
    echo Unknown archive file $archive
    false
fi

ls -l $archive_dir/
ls $archive_dir/*sequencer*.tgz | xargs -n 1 tar -xzf

find $sites_in -name out-seq -print -exec rsync -ah {}/ $sites_out/ \;

src_count=$(find $sites_in/out-seq -name sequence.md | wc -l)
dst_count=$(find $sites_out -name sequence.md | wc -l)

if [[ $src_count != $dst_count ]]; then
    echo Mismatch in src/dst count: $src_count != $dst_count
    false
fi

echo Restored $dst_count test output files to $sites_out

cat out_*/schema.out | sort > out/schema.out
ls -l out/schema.out
