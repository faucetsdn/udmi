#!/bin/bash -e

ROOT_DIR=$(dirname $0)/..

NEW_OUT=out${UDMI_REGISTRY_SUFFIX}
if [[ -n $UDMI_REGISTRY_SUFFIX ]]; then
    echo Relocating $ROOT_DIR/out/ to $NEW_OUT
    mv $ROOT_DIR/out/ $ROOT_DIR/$NEW_OUT || true
fi

TIME=`date --utc +%Y%m%d-%H%M%S`
ARCHIVE=/tmp/udmi-support${UDMI_REGISTRY_SUFFIX}_$TIME.tgz
OUT_DIR=$(realpath $ROOT_DIR/$NEW_OUT --relative-to=$PWD)

CONFIG_FILES="/tmp/validator_config.json /tmp/registrar_config.json /tmp/sequencer_config.json /tmp/pubber_config.json"

mkdir -p $OUT_DIR
echo Copying cached config files to $OUT_DIR/
cp $CONFIG_FILES $OUT_DIR/ || true

site_model=
for config in $CONFIG_FILES; do
    if [[ -f $config && -z $site_model ]]; then
        site_model=$(jq -r .site_model $config)
        site_model=$(realpath --relative-to=$PWD $site_model)
        echo Using site_model $site_model from cached $config
    fi
done

echo tar --exclude-vcs -czf $ARCHIVE $site_model $OUT_DIR
tar --exclude-vcs -czf $ARCHIVE $site_model $OUT_DIR

echo Created support archive $(realpath $ARCHIVE)
ls -l $ARCHIVE
md5sum $ARCHIVE
