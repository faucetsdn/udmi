#!/bin/bash -e

JVERSION=1.1.1
JBASENAME=jsonschema2pojo

ROOT_DIR=$(realpath $(dirname $0)/..)
cd $ROOT_DIR

rm -rf gencode/java codegen/java
mkdir -p codegen gencode

bin/gencode_categories
bin/gencode_buckets

OUTDIR=$ROOT_DIR/gencode/java
cd codegen
GENDIR=$PWD

JARVER=$JBASENAME-$JVERSION
JARBIN=$GENDIR/$JARVER/bin/$JBASENAME

if [[ ! -f $JARBIN ]]; then
    curl -L https://github.com/joelittlejohn/$JBASENAME/releases/download/$JARVER/$JARVER.tar.gz -o $JARVER.tgz
    tar -xzvf $JARVER.tgz
fi

ls -l $JARBIN
cd $ROOT_DIR/schema

find . -name \*~ | xargs -r rm

JOPTS="-fe .json -d . -ds -dg -S -p udmi.schema -ut"
echo Generating code in $OUTDIR
for file in *.json; do
    echo Generating java src for $file
    $JARBIN $JOPTS --source $file --target $OUTDIR
done

# There is no way to specify enum constants in generated code, so just hack it in manually.
echo Copying shared constants $ROOT_DIR/etc/*.java
cp -n $ROOT_DIR/etc/*.java $OUTDIR/udmi/schema/

cd $ROOT_DIR
find gencode/java -type f | sort

echo Done with java code generation.
