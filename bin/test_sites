#!/bin/bash -e

ROOT=$(dirname $0)/..
cd $ROOT

errorfile=`mktemp`
rm -f $errorfile

build=y
force=n

schemadir=schema
testdir=tests

while getopts "d:" opt; do
    case $opt in
        d)
            testdir=${OPTARG}
            ;;
        \?)
            echo "Usage: $0 [-f] [-n] [-d TEST_DATA_DIR]"
            exit -1
            ;;
    esac
done

subsets=$(cd $testdir; ls -d *.site)

rm -rf out/sites
mkdir -p out/sites

echo Testing against $subsets
for subset in $subsets; do
    echo $subset
    outsite=out/sites/$subset
    mkdir -p $outsite
    devicesdir=$testdir/$subset/devices
    devices=$(cd $devicesdir; ls -d *)
    for device in $devices; do
        mkdir -p $outsite/$device
        cp -a $devicesdir/$device/out/*.json $outsite/$device/
        rm -rf $devicesdir/$device/out
    done
    bin/registrar $testdir/$subset
done

echo

echo Done with site tests
