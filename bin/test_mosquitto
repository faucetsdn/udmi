#!/bin/bash -ex

PASSWORD_FILE=/etc/mosquitto/udmi_test.pass
USERNAME=scrumptus
PASSWORD=$RANDOM

echo password_file ${PASSWORD_FILE} | sudo tee /etc/mosquitto/conf.d/udmi_test.conf
sudo sed -i 's/allow_anonymous true/allow_anonymous false/' /etc/mosquitto/mosquitto.conf
sudo sed -i 's/#listener/listener/' /etc/mosquitto/mosquitto.conf

sudo mosquitto_passwd -b -c ${PASSWORD_FILE} ${USERNAME} ${PASSWORD}
sudo chmod 666 ${PASSWORD_FILE}

sudo systemctl restart mosquitto
systemctl status mosquitto

echo Subscribing to mqtt/test in the background...
mosquitto_sub -t mqtt/test -u ${USERNAME} -P ${PASSWORD} &

sleep 1

echo Publishing test message
mosquitto_pub -t mqtt/test -u ${USERNAME} -P ${PASSWORD} -m "Hello MQTT"

sleep 1
