#!/bin/bash -eu

CERT_SUBJ=/CN=reflector
CAKEY=rsa_private.pem

if [[ $# != 1 ]]; then
    echo $0 site_model
    false
fi

site_model=$1
shift

BASE_DIR=$PWD
cd $site_model/reflector

current_files=$(ls ca.* server.* 2> /dev/null) || true
if [[ -n $current_files ]]; then
    echo In $(pwd):
    ls -l $current_files
    echo cert or server files already exist, refusing to clobber.
    false
fi

openssl req -new -x509 -days 3650 -key $CAKEY -out ca.crt --subj $CERT_SUBJ
openssl genrsa -out server.key 2048
openssl req -new -key server.key -out server.csr --subj $CERT_SUBJ
openssl x509 -req -in server.csr -CA ca.crt -CAkey $CAKEY -CAcreateserial -out server.crt -days 3650

cd $BASE_DIR
ls -l $site_model/reflector/ca.* $site_model/reflector/server.*
