#!/bin/bash 

ROOT_DIR=$(realpath $(dirname $0)/..)
cd $ROOT_DIR

OUTPUT_DIR=docs/schema

#Delete existing HTML files
rm -rf OUTPUT_DIR

# Make a copy of the schema files into a tmp folder
rm -rf tmp/schema
mkdir -p tmp/schema
cp -r schema tmp

# Remove file: prefix from references so document generator works
find tmp/schema -type f -exec sed -i '' 's/file://' {} \;

schemas="state event_system event_pointset event_discovery config metadata envelope"

for schema in $schemas; do
    python3 bin/gendocs.py $schema $ROOT_DIR $OUTPUT_DIR
done

rm -rf tmp/schema

# Convert github doc links to relative links
RELATIVE_LINK="..\/"
ABSOLUTE_LINK="https:\/\/github.com\/faucetsdn\/udmi\/blob\/master\/docs\/"
find $OUTPUT_DIR -type f -exec sed -i '' "s/$ABSOLUTE_LINK/$RELATIVE_LINK/" {} \;

# Create index page with links to different schemas
rm $OUTPUT_DIR/index.html
cp etc/schema_index_template.html $OUTPUT_DIR/index.html

for schema in $schemas; do
    sed -i '' "s/<!--SCHEMALINK-->/\
              <div class=\"card\"><a href=\"$schema.html\">$schema<\/a><\/div><!--SCHEMALINK-->/"\
              $OUTPUT_DIR/index.html
done
