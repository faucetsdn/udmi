#!/bin/bash -e

source $(realpath $(dirname $(readlink -f $0))/..)/etc/udmi_preamble.sh

echo $udmi_site
[[ $udmi_site != null ]] || udmi_help site_model not defined
[[ $udmi_project != null ]] || udmi_help project_id not defined

SUMMARY_FILE=out/validation_report.json
rm -f $SUMMARY_FILE

cmd="$UDMI_ROOT/bin/validator $udmi_site $udmi_project"
if [[ $udmi_runsec != null ]]; then
    cmd="timeout ${udmi_runsec}s $cmd"
fi

echo $cmd
result=0
$cmd || result=$?

if [[ $result != 124 ]]; then
    echo abnormal termination not due to timeout.
    false
fi

[[ -f $SUMMARY_FILE ]] || (echo missing summary file $SUMMARY_FILE && false)

mkdir -p out/devices

error_files=$(find out/devices/ -name \*.out)
echo
if [[ -n $error_files ]]; then
    echo Device validation error files:
    find out/devices/ -name \*.out
else
    echo No device validation errors found.
fi
echo
echo Report summary in $SUMMARY_FILE
