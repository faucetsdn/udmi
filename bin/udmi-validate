#!/bin/bash -e

source $(realpath $(dirname $(readlink -f $0))/..)/etc/udmi_preamble.sh

[[ $udmi_project != null ]] || (echo project_id not defined && false)
[[ $udmi_length != null ]] || (echo run_length not defined && false)

SUMMARY_FILE=out/validation_report.json
rm -f $SUMMARY_FILE

cmd="timeout ${udmi_length}s $UDMI_ROOT/bin/validator $site_model $udmi_project"
echo $cmd
result=0
$cmd || result=$?

if [[ $result != 124 ]]; then
    echo abnormal termination not due to timeout.
    false
fi

[[ -f $SUMMARY_FILE ]] || (echo missing summary file $SUMMARY_FILE && false)

mkdir -p out/devices

error_files=$(find out/devices/ -name \*.out)
echo
if [[ -n $error_files ]]; then
    echo Device validation error files:
    find out/devices/ -name \*.out
else
    echo No device validation errors found.
fi
echo
echo Report summary in $SUMMARY_FILE
