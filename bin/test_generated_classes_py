#!/bin/bash -e

set -e

echo "--- Setting up test environment ---"

ROOT_DIR=$(realpath $(dirname $0)/..)
VENV_DIR="$ROOT_DIR/codegen/test_venv"
GENCODE_DIR="$ROOT_DIR/gencode/python/"

echo "Creating virtual environment in '$VENV_DIR'..."
python3 -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"

echo "Installing testing dependencies..."
pip install --upgrade pip
pip install poetry pytest pydantic

echo "Installing gencode project..."
cd  $GENCODE_DIR
poetry install

echo "--- Running tests ---"
poetry run pytest -v -rA "$ROOT_DIR"/bin/test_generated_classes.py

deactivate
echo "--- Test run complete ---"