#!/bin/bash -e

if [ $# != 2 ]; then
    echo $0 site_path project_spec
    false
fi

UDMI_ROOT=$(realpath $(dirname $0)/..)
source $UDMI_ROOT/etc/shell_common.sh

site_path=$(realpath $1)
project_spec=$2
registry_id=$3
shift 2

config_file=$site_path/cloud_iot_config.json
registry_id=$(jq -r .registry_id $config_file)

partial=${project_spec#//}
project_id=${partial#*/}
project_id=${project_id%/*}
protocol=${partial%%/*}
namespace=${project_spec##*/}

use_registry=$registry_id
[[ -n $namespace ]] && use_registry=${namespace}~$registry_id

echo Provisioning reflector protocol $protocol project $project_id registry $use_registry

if [[ $protocol == mqtt ]]; then
    ETCD="$UDMI_ROOT/udmis/bin/etcdctl --endpoints localhost:2379"
    registries=$($ETCD get --print-value-only /registries)
    updated=${registries},$use_registry
    updated=${updated#,}
    $ETCD put /registries "${updated}"
    echo Updated registries ${updated}
else
    fail Unable to provision protocol $protocol
fi
