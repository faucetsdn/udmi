#!/bin/bash -e

INSTANCES=10

bin/build
project_id=$(gcloud config get-value project)
echo Using GCP project $project_id

echo Clearing existing deployment...
kubectl scale deploy pubber-pool --replicas=0

TAG=us.gcr.io/${project_id}/pubber:latest

echo Building docker image...
docker build . -f cluster/Dockerfile.pubber -t udmi/pubber

echo Pushing image tag $TAG
docker tag udmi/pubber:latest $TAG
docker push $TAG

echo Restarting with $INSTANCES replicats...
echo kubectl scale deploy pubber-pool --replicas=$INSTANCES
kubectl scale deploy pubber-pool --replicas=$INSTANCES
