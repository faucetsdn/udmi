#!/bin/bash -e

bin/build
project_id=$(gcloud config get-value project)
echo Using GCP project $project_id

TAG=us.gcr.io/${project_id}/pubber:latest

docker build . -f cluster/Dockerfile.pubber -t udmi/pubber

echo Pushing image tag $TAG
docker tag udmi/pubber:latest $TAG
docker push $TAG

echo Clearing existing deployment...
kubectl scale deploy pubber-pool --replicas=0

sleep 10 # Short sleep to make sure 0 case is accepted.

echo Creating instance replicas...
kubectl scale deploy pubber-pool --replicas=10
