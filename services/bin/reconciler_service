#!/bin/bash -e
#
# Reconciler service
#
SCRIPT_ROOT=$(realpath $(dirname $0))
UDMI_ROOT=$(realpath "$SCRIPT_ROOT"/../..)

source "$UDMI_ROOT"/etc/shell_common.sh

export PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'

LOCAL=
[[ ${1:-} == "--local" ]] && LOCAL=1 && shift

NO_CHECK=
[[ ${1:-} == "--no-check" ]] && NO_CHECK=1 && shift

# shellcheck disable=SC2155
export GCP_PROJECT=$(gcloud config get-value project)
echo Using GCP_PROJECT "$GCP_PROJECT"

if [[ -n ${UDMI_NAMESPACE:-} ]]; then
    UDMI_PREFIX="${UDMI_NAMESPACE}~"
    TARGET="//pubsub/${GCP_PROJECT}/${UDMI_NAMESPACE}"
    echo Using UDMI_PREFIX "$UDMI_PREFIX"
else
    UDMI_PREFIX=
    TARGET="//pubsub/${GCP_PROJECT}"
fi

if [[ -z $LOCAL ]]; then
    GCP_SERVICE_ACCOUNT=$(curl -s -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email)
    echo Configured with GCP service account "$GCP_SERVICE_ACCOUNT"
    gcloud config set account "$GCP_SERVICE_ACCOUNT"
else
  [[ ! -d $UDMI_ROOT/services/src ]] ||
      up_to_date "$SERVICES_JAR" "$UDMI_ROOT"/services/src ||
      "$UDMI_ROOT"/services/bin/build
fi

REPO_UPDATES_TOPIC=${UDMI_PREFIX}source-repo-updates
REPO_UPDATES_SUBSCRIPTION=${UDMI_PREFIX}source-repo-updates-reconciler
PR_NOTIFY_TOPIC=${UDMI_PREFIX}pr-reviews
PR_NOTIFY_SUBSCRIPTION=${UDMI_PREFIX}pr-reviews-subscription
SITE_MODEL_CLONE_DIR=${UDMI_ROOT}/var/udmi/sites

if [[ -z $NO_CHECK ]]; then
    echo Checking existing topics for source repo updates...
    existing_topic=$(gcloud pubsub topics list | grep -F "${REPO_UPDATES_TOPIC}" || true)
    if [[ -n $existing_topic ]]; then
        echo Topic "${REPO_UPDATES_TOPIC}" exists
    else
        echo Creating topic "${REPO_UPDATES_TOPIC}"
        gcloud pubsub topics create "${REPO_UPDATES_TOPIC}"
    fi

    echo Checking existing topics for PR review requests...
    existing_topic=$(gcloud pubsub topics list | grep -F "${PR_NOTIFY_TOPIC}" || true)
    if [[ -n $existing_topic ]]; then
        echo Topic "${PR_NOTIFY_TOPIC}" exists
    else
        echo Creating topic "${PR_NOTIFY_TOPIC}"
        gcloud pubsub topics create "${PR_NOTIFY_TOPIC}"
    fi

    echo Checking existing subscriptions for source repo updates...
    existing=$(gcloud pubsub subscriptions list | grep -F "${REPO_UPDATES_SUBSCRIPTION}" || true)
    if [[ -n $existing ]]; then
        echo Using existing subscription "${REPO_UPDATES_SUBSCRIPTION}"
    else
        gcloud pubsub subscriptions create "${REPO_UPDATES_SUBSCRIPTION}" --topic="${REPO_UPDATES_TOPIC}" --expiration-period=24h
    fi

    echo Checking existing subscriptions for PR review requests...
    existing=$(gcloud pubsub subscriptions list | grep -F "${PR_NOTIFY_SUBSCRIPTION}" || true)
    if [[ -n $existing ]]; then
        echo Using existing subscription "${PR_NOTIFY_SUBSCRIPTION}"
    else
        gcloud pubsub subscriptions create "${PR_NOTIFY_SUBSCRIPTION}" --topic="${PR_NOTIFY_TOPIC}" --expiration-period=24h
    fi
fi

java -cp "$SERVICES_JAR" "com.google.bos.iot.core.reconcile.ReconcilerService" \
    "$TARGET" "$SITE_MODEL_CLONE_DIR"
