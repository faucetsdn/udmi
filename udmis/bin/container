#!/bin/bash -e

ROOT=$(dirname $0)/..
cd $ROOT
DROOT=.
#PROJECT=mqttproxy-arup1
#PROJECT=bos-peringknife-dev
#PROJECT=bos-johnrandolph-ci2
PROJECT=$(gcloud config get project)
REPOSITORY=gcr.io/$PROJECT
IMAGE=udmis

if [[ $# -lt 1 ]]; then
    echo Usage: $0 { build, run, shell, deploy }
    false
fi

cmd=$1
shift

if [[ $cmd == build ]]; then
    docker build -f Dockerfile.udmis -t $IMAGE $DROOT
elif [[ $cmd == run ]]; then
    docker run -v $PWD/etc:/udmi -v $HOME/.config:/root/.config --tmpfs /tmp $IMAGE
elif [[ $cmd == shell ]]; then
    docker run -v $PWD/etc:/udmi -v $HOME/.config:/root/.config --rm -i -t --tmpfs /tmp $IMAGE /bin/sh --login
elif [[ $cmd == deploy ]]; then
    docker tag $IMAGE $REPOSITORY/$IMAGE
    docker push $REPOSITORY/$IMAGE
else
    echo Unknown command $cmd
    false
fi
